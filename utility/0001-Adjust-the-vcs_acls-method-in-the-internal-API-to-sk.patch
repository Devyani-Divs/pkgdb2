From 81f6b95685bdadb21160ede6833a71bcf55696da Mon Sep 17 00:00:00 2001
From: Pierre-Yves Chibon <pingou@pingoured.fr>
Date: Tue, 24 Feb 2015 21:47:02 +0100
Subject: [PATCH 1/2] Adjust the vcs_acls method in the internal API to skip
 the provenpackager for certain packages

---
 pkgdb2/lib/__init__.py | 23 ++++++++++++++++-------
 1 file changed, 16 insertions(+), 7 deletions(-)

diff --git a/pkgdb2/lib/__init__.py b/pkgdb2/lib/__init__.py
index c432a76..e94ab3c 100644
--- a/pkgdb2/lib/__init__.py
+++ b/pkgdb2/lib/__init__.py
@@ -1671,7 +1671,7 @@ def bugzilla(session, name=None):
     return output
 
 
-def vcs_acls(session, eol=False, oformat='text'):
+def vcs_acls(session, eol=False, oformat='text', skip_pp=None):
     """ Return the information to sync ACLs with gitolite.
 
     :arg session: the session to connect to the database with.
@@ -1696,8 +1696,11 @@ def vcs_acls(session, eol=False, oformat='text'):
                 output[pkg[0].encode('utf-8')] = {}
 
             if pkg[2] not in output[pkg[0]]:
+                groups = []
+                if skip_pp and pkg[0] not in skip_pp:
+                    groups.append('provenpackager')
                 output[pkg[0]][pkg[2].encode('utf-8')] = {'commit':
-                    {'groups': ['provenpackager'], 'people': []}
+                    {'groups': groups, 'people': []}
                 }
 
             if group:
@@ -1716,6 +1719,10 @@ def vcs_acls(session, eol=False, oformat='text'):
             else:
                 user = pkg[1]
 
+            groups = ''
+            if pkg[0] not in skip_pp:
+                groups = '@provenpackager'
+
             if pkg[0] in output:
                 if pkg[2] in output[pkg[0]]:
                     if user:
@@ -1723,26 +1730,28 @@ def vcs_acls(session, eol=False, oformat='text'):
                             output[pkg[0]][pkg[2]]['user'] += ','
                         output[pkg[0]][pkg[2]]['user'] += user
                     elif group:  # pragma: no cover
-                        if output[pkg[0]][pkg[2]]['group']:
+                        if output[pkg[0]][pkg[2]]['group'].strip():
                             output[pkg[0]][pkg[2]]['group'] += ','
                         output[pkg[0]][pkg[2]]['group'] += group
                 else:
-                    if group:  # pragma: no cover
+                    if group and groups:  # pragma: no cover
                         group = ',' + group
+
+
                     output[pkg[0]][pkg[2]] = {
                         'name': pkg[0],
                         'user': user or '',
-                        'group': '@provenpackager' + (group or ''),
+                        'group': groups + (group or ''),
                         'branch': pkg[2],
                     }
             else:
-                if group:
+                if group and groups:
                     group = ',' + group
                 output[pkg[0]] = {
                     pkg[2]: {
                         'name': pkg[0],
                         'user': user or '',
-                        'group': '@provenpackager' + (group or ''),
+                        'group': groups + (group or ''),
                         'branch': pkg[2],
                     }
                 }
-- 
2.1.0

